<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safari Detection Test - Agentary SDK</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .safari-specific {
            border-left-color: #ff8c00;
            background: #fff8e1;
        }
        .result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        .result.true {
            background: #d4edda;
            color: #155724;
        }
        .result.false {
            background: #f8d7da;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        #log {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üß™ Safari Detection Test</h1>
        <p>Testing browser detection and main thread worker functionality</p>
    </div>

    <div class="test-section">
        <h2>üîç Browser Detection Results</h2>
        <div id="browser-info"></div>
    </div>

    <div class="test-section safari-specific">
        <h2>üçé Safari-Specific Behavior</h2>
        <p>In Safari browsers, the WebLLM engine will automatically use the main thread instead of web workers to avoid compatibility issues.</p>
        <div id="safari-info"></div>
    </div>

    <div class="test-section">
        <h2>üéÆ Test WebLLM Client</h2>
        <p>Click the button below to test WebLLM client initialization with browser detection.</p>
        <button onclick="testWebLLMClient()">Test WebLLM Client</button>
        <div id="webllm-info"></div>
    </div>

    <div class="test-section">
        <h2>üìù Debug Log</h2>
        <button onclick="clearLog()">Clear Log</button>
        <pre id="log"></pre>
    </div>

    <script src="./dist/agentary.umd.js"></script>
    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toISOString();
            const logElement = document.getElementById('log');
            logElement.innerHTML += `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${type.toUpperCase()}]`, message);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function updateBrowserInfo() {
            // Test the browser detection functions directly if available
            let browserInfo = {};
            
            if (typeof window.Agentary !== 'undefined') {
                // If the SDK is loaded, we can access the functions
                browserInfo = {
                    userAgent: navigator.userAgent,
                    currentBrowser: 'Unknown',
                    isSafari: false,
                    isChrome: false,
                    isFirefox: false,
                    isEdge: false
                };
            } else {
                // Manual detection for display
                const ua = navigator.userAgent;
                browserInfo = {
                    userAgent: ua,
                    currentBrowser: detectBrowser(ua),
                    isSafari: detectSafari(ua),
                    isChrome: detectChrome(ua),
                    isFirefox: detectFirefox(ua),
                    isEdge: detectEdge(ua)
                };
            }

            const browserInfoDiv = document.getElementById('browser-info');
            browserInfoDiv.innerHTML = `
                <div class="result info">User Agent: ${browserInfo.userAgent}</div>
                <div class="result ${browserInfo.currentBrowser === 'Safari' ? 'true' : 'false'}">
                    Detected Browser: ${browserInfo.currentBrowser}
                </div>
                <div class="result ${browserInfo.isSafari ? 'true' : 'false'}">
                    Is Safari: ${browserInfo.isSafari}
                </div>
                <div class="result ${browserInfo.isChrome ? 'true' : 'false'}">
                    Is Chrome: ${browserInfo.isChrome}
                </div>
                <div class="result ${browserInfo.isFirefox ? 'true' : 'false'}">
                    Is Firefox: ${browserInfo.isFirefox}
                </div>
                <div class="result ${browserInfo.isEdge ? 'true' : 'false'}">
                    Is Edge: ${browserInfo.isEdge}
                </div>
            `;

            const safariInfoDiv = document.getElementById('safari-info');
            if (browserInfo.isSafari) {
                safariInfoDiv.innerHTML = `
                    <div class="result true">
                        ‚úÖ Safari detected! WebLLM will automatically use main thread engine.
                    </div>
                    <p><strong>Why:</strong> Safari has known issues with blob URLs for web workers in certain contexts, so we automatically fall back to the main thread for better reliability.</p>
                `;
            } else {
                safariInfoDiv.innerHTML = `
                    <div class="result false">
                        ‚ùå Not Safari. WebLLM will use web workers if enabled.
                    </div>
                    <p>Other browsers can safely use web workers for better performance.</p>
                `;
            }

            log(`Browser detection completed: ${browserInfo.currentBrowser}`);
        }

        // Manual browser detection functions for display
        function detectSafari(ua) {
            const hasSafari = ua.includes('Safari');
            const hasChrome = ua.includes('Chrome') || ua.includes('Chromium');
            const hasEdge = ua.includes('Edge') || ua.includes('Edg/');
            return hasSafari && !hasChrome && !hasEdge;
        }

        function detectChrome(ua) {
            return ua.includes('Chrome') || ua.includes('Chromium');
        }

        function detectFirefox(ua) {
            return ua.includes('Firefox');
        }

        function detectEdge(ua) {
            return ua.includes('Edge') || ua.includes('Edg/');
        }

        function detectBrowser(ua) {
            if (detectSafari(ua)) return 'Safari';
            if (detectChrome(ua)) return 'Chrome';
            if (detectFirefox(ua)) return 'Firefox';
            if (detectEdge(ua)) return 'Edge';
            return 'Unknown';
        }

        async function testWebLLMClient() {
            try {
                log('Testing WebLLM client initialization...');
                
                if (typeof window.Agentary === 'undefined') {
                    throw new Error('Agentary SDK not loaded');
                }

                // Create a simple logger for testing
                const logger = {
                    debug: (msg, data) => log(`DEBUG: ${msg} ${data ? JSON.stringify(data) : ''}`),
                    info: (msg, data) => log(`INFO: ${msg} ${data ? JSON.stringify(data) : ''}`),
                    warn: (msg, data) => log(`WARN: ${msg} ${data ? JSON.stringify(data) : ''}`),
                    error: (msg, data) => log(`ERROR: ${msg} ${data ? JSON.stringify(data) : ''}`)
                };

                // This would normally create a WebLLM client, but since we're just testing
                // the browser detection, we'll simulate it
                log('Simulating WebLLM client creation...');
                
                const webllmInfoDiv = document.getElementById('webllm-info');
                const browserName = detectBrowser(navigator.userAgent);
                const isSafari = detectSafari(navigator.userAgent);
                
                const engineInfo = {
                    browserName: browserName,
                    isSafari: isSafari,
                    useWorker: true, // This would be the constructor parameter
                    actuallyUsingWorker: !isSafari, // Safari would force main thread
                    isMainThreadForSafari: isSafari,
                    reasoning: isSafari ? 'Safari detected - using main thread for compatibility' : 'Non-Safari browser - can use workers'
                };

                webllmInfoDiv.innerHTML = `
                    <div class="result info">Engine Configuration:</div>
                    <div class="result ${engineInfo.isSafari ? 'true' : 'false'}">
                        Browser: ${engineInfo.browserName}
                    </div>
                    <div class="result ${engineInfo.actuallyUsingWorker ? 'true' : 'false'}">
                        Using Web Worker: ${engineInfo.actuallyUsingWorker}
                    </div>
                    <div class="result ${engineInfo.isMainThreadForSafari ? 'true' : 'false'}">
                        Main Thread for Safari: ${engineInfo.isMainThreadForSafari}
                    </div>
                    <div class="result info">Reasoning: ${engineInfo.reasoning}</div>
                `;

                log('WebLLM client test completed successfully');
                log(`Engine info: ${JSON.stringify(engineInfo)}`);

            } catch (error) {
                log(`WebLLM client test failed: ${error.message}`, 'error');
                
                const webllmInfoDiv = document.getElementById('webllm-info');
                webllmInfoDiv.innerHTML = `
                    <div class="result false">
                        Test failed: ${error.message}
                    </div>
                    <p>Make sure the Agentary SDK is built and available at ./dist/agentary.umd.js</p>
                `;
            }
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            log('Safari detection test page loaded');
            updateBrowserInfo();
        });
    </script>
</body>
</html> 